package uo.ri.cws.application.business.mechanic.crud.commands;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import assertion.Argument;
import jdbc.Jdbc;
import uo.ri.cws.application.business.BusinessException;
import uo.ri.cws.application.persistence.PersistenceException;
import uo.ri.cws.application.persistence.PersistenceFactory;
import uo.ri.cws.application.persistence.mechanic.MechanicGateway;

public class DeleteMechanic {
	
	private Connection c = null;
	private PreparedStatement pst = null;
	private ResultSet rs = null;
	
	private MechanicGateway mg = PersistenceFactory.forMechanic();
	private String id = "";
	
	public DeleteMechanic(String id) {
		validate(id);
		this.id = id;
	}

	public void execute() throws BusinessException {
		try {
			try {
				c = Jdbc.createThreadConnection();
				c.setAutoCommit(false);
				
				// Check if mechanic exist with this id
				if (existMechanic(id)) {
					throw new BusinessException("Repeated mechanic");
				}
				notWorkorders(id);
				deleteMechanic(id);
				
				c.commit();
			} catch (BusinessException be) {
				c.rollback();
				throw be;
			}			
		} catch (SQLException | PersistenceException e) {
			throw new RuntimeException(e);
		} finally {
			Jdbc.close(c);
		}
	}

	private boolean existMechanic(String id) throws SQLException, BusinessException {
		if (mg.findById(id).isPresent()) {
			return true;
		} else {
			return false;
		}
	}
	
	private void notWorkorders(String id2) throws SQLException, BusinessException {
		String q = "select * from TWORKORDERS where mechanic_id = ?";
		pst = c.prepareStatement(q);
		pst.setString(1, id);
		rs = pst.executeQuery();

		if (rs.next()) {
			throw new BusinessException("Mechanic has undone works on this moment");
		}
	}
	
	private void deleteMechanic(String id) throws SQLException {
		mg.remove(id);
	}

	private void validate(String arg) {
		// usar clase del proyecto util Argumen
		Argument.isNotEmpty(arg, "Null or empty id");
	}
	
}
